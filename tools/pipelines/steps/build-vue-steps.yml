steps:
  - task: NodeTool@0
    inputs:
      versionSpec: '15.x'
    displayName: 'Install Node.js'

#  - task: Cache@2
#    displayName: Load NPM cache
#    inputs:
#      key: npm | $(Agent.OS) | $(Build.SourcesDirectory)/${{parameters.workingDir}}/yarn.lock
#      restoreKeys: |
#        npm | "$(Agent.OS)"
#      path: $(Build.SourcesDirectory)/${{parameters.workingDir}}/node_modules
#      cacheHitVar: CACHE_HIT

  - task: Yarn@3
    displayName: 'Install NPM dependencies'
    condition: ne(variables['CACHE_HIT'], 'true')
    inputs:
     customRegistry: 'useFeed'
     customFeed: ${{ parameters.packageFeed }}
     arguments: --frozen-lockfile

  - script: node ./tools/scripts/run-commands.js lint ${{parameters.isPullRequest}} ${{parameters.appName}}
    displayName: 'Lint affected packages'
    condition: and(succeeded(), eq('${{ parameters.lint }}', true))

  - script: node ./tools/scripts/run-commands.js coverage ${{parameters.isPullRequest}} ${{parameters.appName}}
    displayName: 'Test affected packages'
    condition: and(succeeded(), eq(variables['build.sourceBranch'], 'refs/heads/master'))

  - task: PublishTestResults@2
    displayName: 'Publish Test Result'
    condition: and(succeededOrFailed(), eq(variables['build.sourceBranch'], 'refs/heads/master'))
    inputs:
      testRunner: VSTest
      testResultsFiles: '**/*result*.trx'
      failTaskOnFailedTests: false

  - script: node ./tools/scripts/merge-test-coverage.js
    displayName: 'Merge Code Coverage Reports'
    condition: and(succeededOrFailed(), eq(variables['build.sourceBranch'], 'refs/heads/master'))

  - task: PublishCodeCoverageResults@1
    displayName: 'Publish Merged Code Coverage'
    inputs:
      codeCoverageTool: 'Cobertura'
      summaryFileLocation: '$(Build.SourcesDirectory)/coverage/merged-cobertura-coverage.xml'
      failIfCoverageEmpty: false
    condition: eq(variables['build.sourceBranch'], 'refs/heads/master')

  - script: yarn ${{ parameters.lokaliseCommand }}
    displayName: 'Lokalise Sync'
    workingDirectory: ${{ parameters.workingDir }}
    condition: and(succeeded(), eq('${{ parameters.lokalise }}', true))

  - script: yarn ${{ parameters.buildCommand }}
    displayName: 'Build'
    workingDirectory: ${{ parameters.workingDir }}

