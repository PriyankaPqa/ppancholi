parameters:
  - name: storage
    displayName: 'The azure storage'
  - name: azureSubscription
    displayName: 'The azure subscription'
  - name: cdnEndpoint
    displayName: 'The CDN endpoint'
  - name: cdnProfile
    displayName: 'The CDN profile'

steps:
  - task: replacetokens@3
    displayName: 'Replace Tokens'
    inputs:
      targetFiles: "$(Pipeline.Workspace)/dist/**/index*.js"
      encoding: "auto"
      writeBOM: true
      verbosity: "detailed"
      actionOnMissing: "warn"
      keepToken: false
      tokenPrefix: "#{"
      tokenSuffix: "}#"
      useLegacyPattern: false
      enableTelemetry: true

  - task: AzureCLI@2
    displayName: 'Clean Storage Folder'
    inputs:
      azureSubscription: '${{ parameters.azureSubscription }}'
      scriptType: 'pscore'
      scriptLocation: 'inlineScript'
      inlineScript: |
        az storage blob delete-batch --source '$web' --account-name ${{ parameters.storage }}$(environment)

  - task: AzureFileCopy@3
    displayName: 'Upload to Azure'
    inputs:
      sourcePath: '$(Pipeline.Workspace)/dist'
      azureSubscription: '${{ parameters.azureSubscription }}'
      destination: 'AzureBlob'
      storage: '${{ parameters.storage }}$(environment)'
      containerName: '$web'

  - task: AzureCLI@2
    displayName: 'Purge CDN'
    inputs:
      azureSubscription: '${{ parameters.azureSubscription }}'
      scriptType: 'pscore'
      scriptLocation: 'inlineScript'
      inlineScript: |
        az cdn endpoint purge -n "${{ parameters.cdnEndpoint }}-$(environment)" -g "$(ResourceGroup)" --profile-name "${{ parameters.cdnProfile }}-$(environment)" --content-paths "/*" --no-wait



